import java.text.SimpleDateFormat


pipeline {
  agent {
    kubernetes {
      label 'mypod'
      defaultContainer 'jnlp'
      yaml readFile "${env.WORKSPACE}/pod.yaml"
    }
  }
  
  options {
    timeout(time: 45, unit: 'MINUTES')
  }
  
  environment {
      GH_USER="tigran10" // Replace me
      DH_USER="digitalinside" // Replace me
      PROJECT="go-demo-3"
  }
  
  stages {
    stage('build docker') {
      steps {
        script {
          currentBuild.displayName = new SimpleDateFormat("yy.MM.dd").format(new Date()) + "-" + env.BUILD_NUMBER
        }
        container('git') {
          sh """git clone https://github.com/${env.GH_USER}/${env.PROJECT}.git ."""
        }
        container('docker') {
            withCredentials([usernamePassword(credentialsId: "docker", usernameVariable: "USER", passwordVariable: "PASS")]) {
                sh """docker login -u $USER -p $PASS"""
            }
            sh """docker image build -t ${env.DH_USER}/${env.PROJECT}:${currentBuild.displayName}-beta ."""
            sh """docker image push ${env.DH_USER}/${env.PROJECT}:${currentBuild.displayName}-beta"""
            sh "docker logout"
        }
      }
    }
  }
}